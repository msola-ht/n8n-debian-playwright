name: Build Debian-based n8n Runners (From Official Source)

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'n8n version tag (leave empty for latest release)'
        required: false
        default: ''
      force_build:
        description: 'Force build even if image exists'
        required: false
        default: false
        type: boolean
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡æ–°ç‰ˆæœ¬ (UTC æ—¶é—´ 00:00)
    - cron: '0 0 * * *'
  push:
    branches: [main]

env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: lunare

jobs:
  # Step 1: è·å– n8n æœ€æ–°å‘è¡Œç‰ˆç‰ˆæœ¬å·
  get-latest-version:
    name: Get Latest n8n Version
    runs-on: ubuntu-latest
    outputs:
      n8n_version: ${{ steps.version.outputs.version }}
      source_repo: ${{ steps.version.outputs.source_repo }}

    steps:
      - name: Get latest n8n release
        id: version
        run: |
          if [ -n "${{ github.event.inputs.n8n_version }}" ]; then
            # ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ç‰ˆæœ¬
            VERSION="${{ github.event.inputs.n8n_version }}"
            echo "Using specified version: $VERSION"
          else
            # è·å– n8n-io/n8n æœ€æ–° release ç‰ˆæœ¬
            echo "Fetching latest n8n release from GitHub API..."

            # è·å–æœ€æ–° release ä¿¡æ¯
            LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/n8n-io/n8n/releases/latest" \
              -H "Accept: application/vnd.github.v3+json")

            # æå–ç‰ˆæœ¬å·ï¼ˆç§»é™¤ v å‰ç¼€ï¼‰
            VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name' | sed 's/^v//')

            if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
              echo "::error::Failed to fetch latest version from GitHub API"
              exit 1
            fi

            echo "Latest n8n version: $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "source_repo=n8n-io/n8n" >> $GITHUB_OUTPUT

  # Step 2: æ£€æŸ¥ Docker Hub é•œåƒæ˜¯å¦å·²å­˜åœ¨
  check-image:
    name: Check Docker Hub Image
    runs-on: ubuntu-latest
    needs: get-latest-version
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: Check if image exists
        id: check
        run: |
          IMAGE_NAME="${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian"
          VERSION="${{ needs.get-latest-version.outputs.n8n_version }}"

          echo "Checking if ${IMAGE_NAME}:${VERSION} exists..."

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          if docker manifest inspect ${IMAGE_NAME}:${VERSION} >/dev/null 2>&1; then
            echo "Image ${IMAGE_NAME}:${VERSION} already exists"
            if [ "${{ github.event.inputs.force_build }}" == "true" ]; then
              echo "Force build enabled, proceeding with build"
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "Skipping build (use force_build=true to override)"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Image ${IMAGE_NAME}:${VERSION} does not exist, proceeding with build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # Step 3: å…‹éš† n8n æºä»£ç å¹¶æ„å»º
  build-from-source:
    name: Build n8n from Source
    runs-on: ubuntu-latest
    needs: [get-latest-version, check-image]
    if: needs.check-image.outputs.should_build == 'true'

    steps:
      - name: Clone n8n repository
        run: |
          REPO="${{ needs.get-latest-version.outputs.source_repo }}"
          VERSION="${{ needs.get-latest-version.outputs.n8n_version }}"

          echo "Cloning ${REPO}..."
          git clone https://github.com/${REPO}.git n8n-source

          echo "Checking out version tag: v${VERSION}"
          cd n8n-source
          git checkout "v${VERSION}" || git checkout "${VERSION}"

          echo "Current commit:"
          git log -1 --oneline

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        working-directory: n8n-source
        run: |
          echo "Installing dependencies with pnpm..."
          pnpm install --frozen-lockfile=false

      - name: Build n8n
        working-directory: n8n-source
        run: |
          echo "Building n8n..."
          pnpm build:n8n

      - name: Verify build output
        working-directory: n8n-source
        run: |
          echo "Verifying build output..."
          ls -la dist/
          ls -la dist/task-runner-javascript/ || echo "task-runner-javascript not found!"

          if [ ! -d "dist/task-runner-javascript" ]; then
            echo "::error::task-runner-javascript directory not found in dist/"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-runner-dist
          path: n8n-source/dist/task-runner-javascript
          retention-days: 1

  # Step 4: æ„å»º Debian é•œåƒï¼ˆå¤šæ¶æ„ï¼‰
  build-debian-runners:
    name: Build Debian Runners
    runs-on: ubuntu-latest
    needs: [get-latest-version, build-from-source]
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]

    steps:
      - name: Create Dockerfile directory
        run: |
          mkdir -p docker/images/runners

      - name: Create Dockerfile.debian
        run: |
          cat > docker/images/runners/Dockerfile.debian << 'EOF'
          # Debian-based n8n task runner
          FROM debian:bullseye-slim

          # æ„å»ºå‚æ•°
          ARG NODE_VERSION=22.21.0
          ARG PYTHON_VERSION=3.13
          ARG N8N_VERSION
          ARG N8N_RELEASE_TYPE=stable

          # è®¾ç½®ç¯å¢ƒå˜é‡
          ENV NODE_VERSION=${NODE_VERSION}
          ENV DEBIAN_FRONTEND=noninteractive

          # å®‰è£…åŸºç¡€ä¾èµ–
          RUN apt-get update && apt-get install -y --no-install-recommends \
              curl \
              gnupg \
              ca-certificates \
              build-essential \
              python3 \
              python3-pip \
              git \
              libglib2.0-0 \
              libnss3 \
              libnspr4 \
              libatk1.0-0 \
              libatk-bridge2.0-0 \
              libcups2 \
              libdrm2 \
              libdbus-1-3 \
              libxkbcommon0 \
              libxcomposite1 \
              libxdamage1 \
              libxfixes3 \
              libxrandr2 \
              libgbm1 \
              libasound2 \
              && rm -rf /var/lib/apt/lists/*

          # å®‰è£… Node.js
          RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
              apt-get install -y nodejs && \
              rm -rf /var/lib/apt/lists/*

          # å®‰è£… Python
          RUN apt-get update && apt-get install -y --no-install-recommends \
              python3 \
              python3-pip \
              python3-venv \
              && rm -rf /var/lib/apt/lists/*

          # åˆ›å»ºå·¥ä½œç›®å½•
          WORKDIR /home/node

          # å¤åˆ¶æ„å»ºäº§ç‰©
          COPY --chown=node:node dist/task-runner-javascript /home/node/task-runner

          # å®‰è£…ä»»åŠ¡è¿è¡Œå™¨ä¾èµ–
          RUN cd /home/node/task-runner && \
              npm install --production && \
              chown -R node:node /home/node

          # åˆ‡æ¢åˆ° node ç”¨æˆ·
          USER node

          # è®¾ç½®å·¥ä½œç›®å½•
          WORKDIR /home/node/task-runner

          # æš´éœ²ç«¯å£
          EXPOSE 5680

          # å¯åŠ¨å‘½ä»¤
          CMD ["node", "task-runner.js"]
          EOF

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: task-runner-dist
          path: dist/task-runner-javascript

      - name: Verify artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la dist/
          ls -la dist/task-runner-javascript/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/images/runners/Dockerfile.debian
          platforms: ${{ matrix.platform }}
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:${{ needs.get-latest-version.outputs.n8n_version }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
          build-args: |
            NODE_VERSION=22.21.0
            PYTHON_VERSION=3.13
            N8N_VERSION=${{ needs.get-latest-version.outputs.n8n_version }}
            N8N_RELEASE_TYPE=stable
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Step 5: åˆ›å»ºå¤šæ¶æ„ manifest
  create-manifest:
    runs-on: ubuntu-latest
    needs: [get-latest-version, build-debian-runners]

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create and push multi-arch manifest
        run: |
          IMAGE_NAME="${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian"
          VERSION="${{ needs.get-latest-version.outputs.n8n_version }}"

          # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾çš„ manifest
          docker buildx imagetools create \
            -t ${IMAGE_NAME}:${VERSION} \
            ${IMAGE_NAME}:${VERSION}-amd64 \
            ${IMAGE_NAME}:${VERSION}-arm64

          # åˆ›å»º latest æ ‡ç­¾çš„ manifest
          docker buildx imagetools create \
            -t ${IMAGE_NAME}:latest \
            ${IMAGE_NAME}:${VERSION}-amd64 \
            ${IMAGE_NAME}:${VERSION}-arm64

          echo "âœ… Manifests created successfully!"
          echo "ğŸ“ Image: ${IMAGE_NAME}:${VERSION}"
          echo "ğŸ“ Multi-arch support: amd64, arm64"

          # æ¸…ç†ä¸´æ—¶æ¶æ„ç‰¹å®šæ ‡ç­¾
          echo "ğŸ§¹ Cleaning up temporary tags..."
          docker buildx imagetools rm ${IMAGE_NAME}:${VERSION}-amd64 || true
          docker buildx imagetools rm ${IMAGE_NAME}:${VERSION}-arm64 || true
          echo "âœ… Temporary tags cleaned up!"

  # Step 6: åˆ›å»º GitHub Release
  create-release:
    runs-on: ubuntu-latest
    needs: [get-latest-version, create-manifest]
    if: (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get-latest-version.outputs.n8n_version }}-debian
          name: Debian-based n8n Runners v${{ needs.get-latest-version.outputs.n8n_version }}
          body: |
            ## Features
            - Based on Debian 11 bullseye-slim
            - Built from n8n-io/n8n official source v${{ needs.get-latest-version.outputs.n8n_version }}
            - Multi-architecture support: amd64, arm64

            ## Docker Images
            - `${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:${{ needs.get-latest-version.outputs.n8n_version }}`
            - `${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:latest`

            ## Source
            - Built from: https://github.com/n8n-io/n8n/releases/tag/v${{ needs.get-latest-version.outputs.n8n_version }}

            ## Usage
            ```bash
            docker run -d \
              -e N8N_RUNNERS_AUTH_TOKEN=your-token \
              -e N8N_RUNNERS_TASK_BROKER_URI=http://your-n8n:5679 \
              -p 5680:5680 \
              ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:${{ needs.get-latest-version.outputs.n8n_version }}
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
