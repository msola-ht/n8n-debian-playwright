name: Build Debian-based n8n Runners (From Official Source)

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'n8n version tag (leave empty for latest release)'
        required: false
        default: ''
      force_build:
        description: 'Force build even if image exists'
        required: false
        default: false
        type: boolean
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡æ–°ç‰ˆæœ¬ (UTC æ—¶é—´ 00:00)
    - cron: '0 0 * * *'
  push:
    branches: [main]

env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: lunare

jobs:
  # Step 1: è·å– n8n æœ€æ–°å‘è¡Œç‰ˆç‰ˆæœ¬å·
  get-latest-version:
    name: Get Latest n8n Version
    runs-on: ubuntu-latest
    outputs:
      n8n_version: ${{ steps.version.outputs.version }}
      n8n_tag: ${{ steps.version.outputs.tag }}
      source_repo: ${{ steps.version.outputs.source_repo }}

    steps:
      - name: Get latest n8n release
        id: version
        run: |
          if [ -n "${{ github.event.inputs.n8n_version }}" ]; then
            # ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ç‰ˆæœ¬
            TAG="${{ github.event.inputs.n8n_version }}"
            VERSION=$(echo "$TAG" | sed -E 's/^(v|n8n@)//')
            echo "Using specified version: $VERSION"
          else
            # è·å– n8n-io/n8n æœ€æ–° release ç‰ˆæœ¬
            echo "Fetching latest n8n release from GitHub API..."

            # è·å–æœ€æ–° release ä¿¡æ¯
            LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/n8n-io/n8n/releases/latest" \
              -H "Accept: application/vnd.github.v3+json")

            # è·å–åŸå§‹ tag åç§°
            TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
            # æå–ç‰ˆæœ¬å·ï¼ˆç§»é™¤ v æˆ– n8n@ å‰ç¼€ï¼‰
            VERSION=$(echo "$TAG" | sed -E 's/^(v|n8n@)//')

            if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
              echo "::error::Failed to fetch latest version from GitHub API"
              exit 1
            fi

            echo "Latest n8n tag: $TAG"
            echo "Latest n8n version: $VERSION"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "source_repo=n8n-io/n8n" >> $GITHUB_OUTPUT

  # Step 2: æ£€æŸ¥ Docker Hub é•œåƒæ˜¯å¦å·²å­˜åœ¨
  check-image:
    name: Check Docker Hub Image
    runs-on: ubuntu-latest
    needs: get-latest-version
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: Check if image exists
        id: check
        run: |
          IMAGE_NAME="${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian"
          VERSION="${{ needs.get-latest-version.outputs.n8n_version }}"

          echo "Checking if ${IMAGE_NAME}:${VERSION} exists..."

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          if docker manifest inspect ${IMAGE_NAME}:${VERSION} >/dev/null 2>&1; then
            echo "Image ${IMAGE_NAME}:${VERSION} already exists"
            if [ "${{ github.event.inputs.force_build }}" == "true" ]; then
              echo "Force build enabled, proceeding with build"
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "Skipping build (use force_build=true to override)"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Image ${IMAGE_NAME}:${VERSION} does not exist, proceeding with build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # Step 3: å…‹éš† n8n æºä»£ç å¹¶æ„å»º
  build-from-source:
    name: Build n8n from Source
    runs-on: ubuntu-latest
    needs: [get-latest-version, check-image]
    if: needs.check-image.outputs.should_build == 'true'
    outputs:
      n8n_version: ${{ needs.get-latest-version.outputs.n8n_version }}

    steps:
      - name: Checkout n8n repository
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.get-latest-version.outputs.source_repo }}
          ref: ${{ needs.get-latest-version.outputs.n8n_tag }}
          path: n8n-source
          sparse-checkout: |
            package.json
            pnpm-workspace.yaml
            pnpm-lock.yaml
            turbo.json
            .npmrc
            patches/
            scripts/
            src/
            packages/
            tsconfig.json
          sparse-checkout-cone-mode: false

      - name: Show current commit
        working-directory: n8n-source
        run: |
          echo "Current commit:"
          git log -1 --oneline
          echo "Current tag:"
          git describe --tags --exact-match 2>/dev/null || echo "no tag"

      - name: Read pnpm version from source
        id: pnpm-version
        working-directory: n8n-source
        run: |
          # è¯»å– packageManager å­—æ®µï¼Œæ ¼å¼ä¸º "pnpm@x.x.x"
          PACKAGE_MANAGER=$(node -p "require('./package.json').packageManager")
          echo "packageManager: $PACKAGE_MANAGER"

          # æå–ç‰ˆæœ¬å·
          PNPM_VERSION=$(echo "$PACKAGE_MANAGER" | sed 's/pnpm@//')
          echo "pnpm-version=$PNPM_VERSION" >> $GITHUB_OUTPUT
          echo "Detected pnpm version: $PNPM_VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ steps.pnpm-version.outputs.pnpm-version }}

      - name: Install dependencies
        working-directory: n8n-source
        run: |
          echo "Installing dependencies with pnpm..."
          pnpm install --frozen-lockfile=false

      - name: Build n8n
        working-directory: n8n-source
        run: |
          echo "Building n8n..."
          pnpm build:n8n

      - name: Verify build output
        working-directory: n8n-source
        run: |
          echo "Verifying build output..."
          ls -la dist/
          ls -la dist/task-runner-javascript/ || echo "task-runner-javascript not found!"

          if [ ! -d "dist/task-runner-javascript" ]; then
            echo "::error::task-runner-javascript directory not found in dist/"
            exit 1
          fi

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-runner-dist
          path: n8n-source/dist
          retention-days: 1

      - name: Upload packages artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-runner-packages
          path: n8n-source/packages
          retention-days: 1

  # Step 4: æ„å»º Debian é•œåƒï¼ˆå¤šæ¶æ„ï¼‰
  build-debian-runners:
    name: Build Debian Runners
    runs-on: ubuntu-latest
    needs: [get-latest-version, build-from-source]
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: task-runner-dist
          path: dist

      - name: Download packages artifacts
        uses: actions/download-artifact@v4
        with:
          name: task-runner-packages
          path: packages

      - name: Verify artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la dist/
          ls -la dist/task-runner-javascript/
          ls -la packages/@n8n/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.debian
          platforms: ${{ matrix.platform }}
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:${{ needs.get-latest-version.outputs.n8n_version }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
          build-args: |
            NODE_VERSION=22.21.0
            PYTHON_VERSION=3.13
            N8N_VERSION=${{ needs.get-latest-version.outputs.n8n_version }}
            N8N_RELEASE_TYPE=stable
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Step 5: åˆ›å»ºå¤šæ¶æ„ manifest
  create-manifest:
    runs-on: ubuntu-latest
    needs: [get-latest-version, build-debian-runners]

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create and push multi-arch manifest
        run: |
          IMAGE_NAME="${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian"
          VERSION="${{ needs.get-latest-version.outputs.n8n_version }}"

          # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾çš„ manifest
          docker buildx imagetools create \
            -t ${IMAGE_NAME}:${VERSION} \
            ${IMAGE_NAME}:${VERSION}-amd64 \
            ${IMAGE_NAME}:${VERSION}-arm64

          echo "âœ… Manifests created successfully!"
          echo "ğŸ“ Image: ${IMAGE_NAME}:${VERSION}"
          echo "ğŸ“ Multi-arch support: amd64, arm64"

          # æ¸…ç†ä¸´æ—¶æ¶æ„ç‰¹å®šæ ‡ç­¾
          echo "ğŸ§¹ Cleaning up temporary tags..."
          docker buildx imagetools rm ${IMAGE_NAME}:${VERSION}-amd64 || true
          docker buildx imagetools rm ${IMAGE_NAME}:${VERSION}-arm64 || true
          echo "âœ… Temporary tags cleaned up!"

  # Step 6: æ„å»º Playwright é•œåƒï¼ˆå¤šæ¶æ„ï¼‰
  build-playwright-runners:
    name: Build Playwright Runners
    runs-on: ubuntu-latest
    needs: [get-latest-version, create-manifest]
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Playwright image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.playwright
          platforms: ${{ matrix.platform }}
          push: true
          build-args: |
            N8N_VERSION=${{ needs.get-latest-version.outputs.n8n_version }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-playwright:${{ needs.get-latest-version.outputs.n8n_version }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Step 7: åˆ›å»º Playwright å¤šæ¶æ„ manifest
  create-playwright-manifest:
    runs-on: ubuntu-latest
    needs: [get-latest-version, build-playwright-runners]

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create and push Playwright multi-arch manifest
        run: |
          IMAGE_NAME="${{ env.DOCKERHUB_USERNAME }}/n8n-runners-playwright"
          VERSION="${{ needs.get-latest-version.outputs.n8n_version }}"

          # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾çš„ manifest
          docker buildx imagetools create \
            -t ${IMAGE_NAME}:${VERSION} \
            ${IMAGE_NAME}:${VERSION}-amd64 \
            ${IMAGE_NAME}:${VERSION}-arm64

          echo "âœ… Playwright Manifests created successfully!"
          echo "ğŸ“ Image: ${IMAGE_NAME}:${VERSION}"
          echo "ğŸ“ Multi-arch support: amd64, arm64"

          # æ¸…ç†ä¸´æ—¶æ¶æ„ç‰¹å®šæ ‡ç­¾
          echo "ğŸ§¹ Cleaning up temporary tags..."
          docker buildx imagetools rm ${IMAGE_NAME}:${VERSION}-amd64 || true
          docker buildx imagetools rm ${IMAGE_NAME}:${VERSION}-arm64 || true
          echo "âœ… Temporary tags cleaned up!"

  # Step 8: åˆ›å»º GitHub Release
  create-release:
    runs-on: ubuntu-latest
    needs: [get-latest-version, create-playwright-manifest]
    if: (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get-latest-version.outputs.n8n_version }}-debian
          name: n8n Runners v${{ needs.get-latest-version.outputs.n8n_version }} (Debian + Playwright)
          body: |
            ## Features
            - Based on Debian 11 bullseye-slim
            - Built from n8n-io/n8n official source v${{ needs.get-latest-version.outputs.n8n_version }}
            - Multi-architecture support: amd64, arm64

            ## Available Images

            ### Base Debian Image
            - `${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:${{ needs.get-latest-version.outputs.n8n_version }}` (amd64 + arm64)

            ### Playwright Extended Image
            - `${{ env.DOCKERHUB_USERNAME }}/n8n-runners-playwright:${{ needs.get-latest-version.outputs.n8n_version }}` (amd64 + arm64)

            Includes: `playwright` + `markdown` Python packages

            ## Source
            - Built from: https://github.com/n8n-io/n8n/releases/tag/v${{ needs.get-latest-version.outputs.n8n_version }}

            ## Usage

            ### Base Debian Image
            ```bash
            docker run -d \
              -e N8N_RUNNERS_AUTH_TOKEN=your-token \
              -e N8N_RUNNERS_TASK_BROKER_URI=http://your-n8n:5679 \
              -p 5680:5680 \
              ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:${{ needs.get-latest-version.outputs.n8n_version }}
            ```

            ### Playwright Image (with browser automation support)
            ```bash
            docker run -d \
              -e N8N_RUNNERS_AUTH_TOKEN=your-token \
              -e N8N_RUNNERS_TASK_BROKER_URI=http://your-n8n:5679 \
              -p 5680:5680 \
              ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-playwright:${{ needs.get-latest-version.outputs.n8n_version }}
            ```

            ## Pull Commands
            ```bash
            # Pull base image
            docker pull ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-debian:${{ needs.get-latest-version.outputs.n8n_version }}

            # Pull playwright image
            docker pull ${{ env.DOCKERHUB_USERNAME }}/n8n-runners-playwright:${{ needs.get-latest-version.outputs.n8n_version }}
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
